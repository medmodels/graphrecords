name: Link Epic Branch

on:
  issues:
    types: [opened, labeled]

jobs:
  link-epic-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    if: >-
      github.event.action == 'opened' && contains(github.event.issue.labels.*.name, 'epic')
      || github.event.action == 'labeled' && github.event.label.name == 'epic'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Link branch to issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          ISSUE_TITLE="${{ github.event.issue.title }}"

          # Convert issue title to kebab case
          KEBAB_TITLE=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-zA-Z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')

          # Construct branch name
          BRANCH_NAME="epic/${ISSUE_NUMBER}-${KEBAB_TITLE}"

          if gh api "repos/${{ github.repository }}/git/ref/heads/${BRANCH_NAME}" > /dev/null 2>&1; then
            echo "Branch $BRANCH_NAME already exists"
            exit 0
          fi

          gh issue develop $ISSUE_NUMBER --name "$BRANCH_NAME"
          gh issue comment $ISSUE_NUMBER --body "Linked development branch for this epic: \`$BRANCH_NAME\`"
